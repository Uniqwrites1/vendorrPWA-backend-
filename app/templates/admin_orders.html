{% extends "admin_base.html" %}

{% block content %}
<!-- Orders Management Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-0">Order Management</h4>
        <p class="text-muted mb-0">Manage and track restaurant orders</p>
    </div>
    <div>
        <button class="btn btn-success" onclick="refreshOrders()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Order Filters -->
<div class="stat-card mb-4">
    <div class="row">
        <div class="col-md-3">
            <select class="form-select" id="statusFilter">
                <option value="">All Statuses</option>
                <option value="pending_payment">Pending Payment</option>
                <option value="payment_confirmed">Payment Confirmed</option>
                <option value="preparing">Preparing</option>
                <option value="almost_ready">Almost Ready</option>
                <option value="ready_for_pickup">Ready for Pickup</option>
                <option value="delivered">Delivered</option>
                <option value="completed">Completed</option>
                <option value="cancelled">Cancelled</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="date" class="form-control" id="dateFilter" placeholder="Filter by date">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="customerFilter" placeholder="Search customer...">
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary" onclick="applyFilters()">
                <i class="fas fa-filter"></i> Apply Filters
            </button>
        </div>
    </div>
</div>

<!-- Orders Table -->
<div class="stat-card">
    <div class="table-responsive">
        <table class="table table-hover" id="ordersTable">
            <thead class="table-light">
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Items</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Payment</th>
                    <th>Created</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in orders %}
                <tr id="order-{{ order.id }}">
                    <td>
                        <strong>#{{ order.id }}</strong>
                    </td>
                    <td>
                        <div>
                            <strong>{{ order.customer }}</strong>
                        </div>
                    </td>
                    <td>
                        <small class="text-muted">{{ order.items }}</small>
                    </td>
                    <td>
                        <strong>${{ "%.2f"|format(order.total) }}</strong>
                    </td>
                    <td>
                        <select class="form-select form-select-sm status-select"
                                data-order-id="{{ order.id }}"
                                onchange="updateOrderStatus({{ order.id }}, this.value)">
                            <option value="pending_payment" {% if order.status == 'pending_payment' %}selected{% endif %}>Pending Payment</option>
                            <option value="payment_confirmed" {% if order.status == 'payment_confirmed' %}selected{% endif %}>Payment Confirmed</option>
                            <option value="preparing" {% if order.status == 'preparing' %}selected{% endif %}>Preparing</option>
                            <option value="almost_ready" {% if order.status == 'almost_ready' %}selected{% endif %}>Almost Ready</option>
                            <option value="ready_for_pickup" {% if order.status == 'ready_for_pickup' %}selected{% endif %}>Ready for Pickup</option>
                            <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                            <option value="completed" {% if order.status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <select class="form-select form-select-sm payment-select"
                                data-order-id="{{ order.id }}"
                                onchange="updatePaymentStatus({{ order.id }}, this.value)">
                            <option value="pending" {% if order.payment_status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="completed" {% if order.payment_status == 'completed' %}selected{% endif %}>Completed</option>
                            <option value="failed" {% if order.payment_status == 'failed' %}selected{% endif %}>Failed</option>
                            <option value="refunded" {% if order.payment_status == 'refunded' %}selected{% endif %}>Refunded</option>
                        </select>
                        {% if order.payment_method == 'bank_transfer' %}
                            <button class="btn btn-sm btn-info mt-1" onclick="viewPaymentProof({{ order.id }})">
                                View Proof
                            </button>
                        {% endif %}
                    </td>
                    <td>
                        <small>{{ order.created_at }}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="viewOrderDetails({{ order.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="printOrder({{ order.id }})">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Order Details Modal -->
<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent">
                <!-- Order details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="printOrder()">Print Order</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateOrderStatus(orderId, newStatus) {
    fetch(`/admin/api/orders/${orderId}/update-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({status: newStatus})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the row styling based on status
            const row = document.getElementById(`order-${orderId}`);
            row.classList.remove('table-success', 'table-warning', 'table-info');

            if (newStatus === 'completed') {
                row.classList.add('table-success');
            } else if (newStatus === 'delivered') {
                row.classList.add('table-success');
            } else if (newStatus === 'preparing') {
                row.classList.add('table-warning');
            } else if (newStatus === 'ready_for_pickup') {
                row.classList.add('table-info');
            }

            // Show success message
            showAlert('Order status updated successfully!', 'success');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating order status', 'danger');
    });
}

function updatePaymentStatus(orderId, newPaymentStatus) {
    fetch(`/admin/api/orders/${orderId}/update-payment-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({payment_status: newPaymentStatus})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Payment status updated successfully!', 'success');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating payment status', 'danger');
    });
}

function viewPaymentProof(orderId) {
    fetch(`/admin/api/orders/${orderId}/payment-proof`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const proof = data.data;
            const proofHtml = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>Payment Information</h6>
                        <p><strong>Reference Number:</strong> ${proof.reference_number}</p>
                        <p><strong>Amount:</strong> $${proof.amount.toFixed(2)}</p>
                        <p><strong>Sender Name:</strong> ${proof.sender_name}</p>
                        <p><strong>Sender Account:</strong> ${proof.sender_account}</p>
                        <p><strong>Verification Status:</strong>
                            <span class="badge bg-${proof.verification_status === 'verified' ? 'success' : 'warning'}">
                                ${proof.verification_status}
                            </span>
                        </p>
                        ${proof.notes ? `<p><strong>Notes:</strong> ${proof.notes}</p>` : ''}
                    </div>
                    <div class="col-md-6">
                        <h6>Payment Receipt</h6>
                        ${proof.receipt_image_url ?
                            `<img src="/uploads/${proof.receipt_image_url}" class="img-fluid" alt="Payment Receipt" />` :
                            '<p class="text-muted">No receipt image uploaded</p>'
                        }
                    </div>
                </div>
            `;
            document.getElementById('orderDetailsContent').innerHTML = proofHtml;
            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
        } else {
            showAlert('No payment proof found for this order', 'warning');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error loading payment proof', 'danger');
    });
}

function viewOrderDetails(orderId) {
    // In production, fetch real order details
    const orderDetails = `
        <div class="row">
            <div class="col-md-6">
                <h6>Order Information</h6>
                <p><strong>Order ID:</strong> #${orderId}</p>
                <p><strong>Customer:</strong> John Doe</p>
                <p><strong>Phone:</strong> +1 234 567 8900</p>
                <p><strong>Status:</strong> <span class="badge bg-warning">Preparing</span></p>
            </div>
            <div class="col-md-6">
                <h6>Order Items</h6>
                <ul class="list-unstyled">
                    <li>1x Classic Burger - $12.99</li>
                    <li>1x French Fries - $4.99</li>
                    <li>1x Coca Cola - $2.99</li>
                </ul>
                <hr>
                <p><strong>Total: $20.97</strong></p>
            </div>
        </div>
    `;

    document.getElementById('orderDetailsContent').innerHTML = orderDetails;
    new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
}

function printOrder(orderId) {
    // In production, generate and print order receipt
    window.print();
}

function refreshOrders() {
    location.reload();
}

function applyFilters() {
    // In production, implement filtering logic
    showAlert('Filters applied successfully!', 'info');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
