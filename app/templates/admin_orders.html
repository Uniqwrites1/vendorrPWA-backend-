{% extends "admin_base.html" %}TEST

{% block title %}Order Management{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2>Order Management</h2>
    <div id="alertContainer"></div>
    <table class="table table-hover">
        <thead>
            <tr>
                <th>ID</th>
                <th>Customer</th>
                <th>Items</th>
                <th>Total</th>
                <th>Payment</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr id="order-{{ order['id'] }}">
                <td>#{{ order['id'] }}</td>
                <td>{{ order['customer'] }}</td>
                <td>{{ order['items'] }}</td>
                <td>₦{{ "%.2f"|format(order['total']) }}</td>
                <td>
                    <select class="form-select form-select-sm" onchange="updatePaymentStatus({{ order['id'] }}, this.value)">
                        <option value="pending" {% if order['payment_status'] == 'pending' %}selected{% endif %}>Pending</option>
                        <option value="paid" {% if order['payment_status'] == 'paid' %}selected{% endif %}>Paid</option>
                        <option value="failed" {% if order['payment_status'] == 'failed' %}selected{% endif %}>Failed</option>
                        <option value="refunded" {% if order['payment_status'] == 'refunded' %}selected{% endif %}>Refunded</option>
                    </select>
                </td>
                <td>
                    <select class="form-select form-select-sm" onchange="updateOrderStatus({{ order['id'] }}, this.value)">
                        <option value="pending_payment" {% if order['status'] == 'pending_payment' %}selected{% endif %}>Pending Payment</option>
                        <option value="payment_confirmed" {% if order['status'] == 'payment_confirmed' %}selected{% endif %}>Payment Confirmed</option>
                        <option value="preparing" {% if order['status'] == 'preparing' %}selected{% endif %}>Preparing</option>
                        <option value="almost_ready" {% if order['status'] == 'almost_ready' %}selected{% endif %}>Almost Ready</option>
                        <option value="ready_for_pickup" {% if order['status'] == 'ready_for_pickup' %}selected{% endif %}>Ready for Pickup</option>
                        <option value="delivered" {% if order['status'] == 'delivered' %}selected{% endif %}>Delivered</option>
                        <option value="completed" {% if order['status'] == 'completed' %}selected{% endif %}>Completed</option>
                        <option value="cancelled" {% if order['status'] == 'cancelled' %}selected{% endif %}>Cancelled</option>
                    </select>
                </td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="viewOrderDetails({{ order['id'] }})">
                        <i class="fas fa-eye"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="orderDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Order Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderDetailsContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function showAlert(msg, type) {
    var div = document.createElement('div');
    div.className = 'alert alert-' + type;
    div.textContent = msg;
    document.getElementById('alertContainer').appendChild(div);
    setTimeout(function() { div.remove(); }, 5000);
}

function updateOrderStatus(orderId, status) {
    fetch('/admin/api/orders/' + orderId + '/update-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status: status})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.success) showAlert('Status updated', 'success');
        else showAlert('Failed to update', 'danger');
    })
    .catch(function() { showAlert('Error', 'danger'); });
}

function updatePaymentStatus(orderId, status) {
    fetch('/admin/api/orders/' + orderId + '/update-payment-status', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({payment_status: status})
    })
    .then(function(r) { return r.json(); })
    .then(function(d) {
        if (d.success) showAlert('Payment updated', 'success');
    })
    .catch(function() { showAlert('Error', 'danger'); });
}

function viewOrderDetails(orderId) {
    fetch('/admin/api/orders/' + orderId)
    .then(function(r) { return r.json(); })
    .then(function(o) {
        var html = '<h6>Order #' + o.order_number + '</h6>';
        html += '<p>Customer: ' + o.customer_name + '</p>';
        html += '<p>Total: ₦' + parseFloat(o.total).toFixed(2) + '</p>';
        document.getElementById('orderDetailsContent').innerHTML = html;
        new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();
    })
    .catch(function() { showAlert('Error loading details', 'danger'); });
}
</script>
{% endblock %}
