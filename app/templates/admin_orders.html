{% extends "admin_base.html" %}{% extends "admin_base.html" %}{% extends "admin_base.html" %}



{% block title %}Order Management - Vendorr Admin{% endblock %}



{% block content %}{% block title %}Order Management - Vendorr Admin{% endblock %}{% block content %}

<div class="container-fluid">

    <div class="d-flex justify-content-between align-items-center mb-4"><!-- Orders Management Header -->

        <h2><i class="fas fa-shopping-cart me-2"></i>Order Management</h2>

        <button class="btn btn-primary" onclick="refreshOrders()">{% block content %}<div class="d-flex justify-content-between align-items-center mb-4">

            <i class="fas fa-sync-alt"></i> Refresh

        </button><div class="container-fluid">    <div>

    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">        <h4 class="mb-0">Order Management</h4>

    <!-- Alert Container -->

    <div id="alertContainer"></div>        <h2><i class="fas fa-shopping-cart me-2"></i>Order Management</h2>        <p class="text-muted mb-0">Manage and track restaurant orders</p>



    <!-- Orders Table -->        <button class="btn btn-primary" onclick="refreshOrders()">    </div>

    <div class="card shadow-sm">

        <div class="card-body">            <i class="fas fa-sync-alt"></i> Refresh    <div>

            <div class="table-responsive">

                <table class="table table-hover align-middle" id="ordersTable">        </button>        <button class="btn btn-success" onclick="refreshOrders()">

                    <thead class="table-light">

                        <tr>    </div>            <i class="fas fa-sync-alt"></i> Refresh

                            <th>Order ID</th>

                            <th>Customer</th>        </button>

                            <th>Items</th>

                            <th>Total</th>    <!-- Alert Container -->    </div>

                            <th>Payment Status</th>

                            <th>Order Status</th>    <div id="alertContainer"></div></div>

                            <th>Order Time</th>

                            <th>Actions</th>

                        </tr>

                    </thead>    <!-- Orders Table --><!-- Order Filters -->

                    <tbody>

                        {% for order in orders %}    <div class="card shadow-sm"><div class="stat-card mb-4">

                        <tr id="order-{{ order['id'] }}" class="order-row-{{ order['status'] }}">

                            <td><strong>#{{ order['id'] }}</strong></td>        <div class="card-body">    <div class="row">

                            <td>{{ order['customer'] }}</td>

                            <td><small class="text-muted">{{ order['items'] }}</small></td>            <div class="table-responsive">        <div class="col-md-3">

                            <td><strong>₦{{ "%.2f"|format(order['total']) }}</strong></td>

                            <td>                <table class="table table-hover align-middle" id="ordersTable">            <select class="form-select" id="statusFilter">

                                <select class="form-select form-select-sm payment-status-select"

                                        onchange="updatePaymentStatus({{ order['id'] }}, this.value)">                    <thead class="table-light">                <option value="">All Statuses</option>

                                    <option value="pending" {% if order['payment_status'] == 'pending' %}selected{% endif %}>Pending</option>

                                    <option value="paid" {% if order['payment_status'] == 'paid' %}selected{% endif %}>Paid</option>                        <tr>                <option value="pending_payment">Pending Payment</option>

                                    <option value="failed" {% if order['payment_status'] == 'failed' %}selected{% endif %}>Failed</option>

                                    <option value="refunded" {% if order['payment_status'] == 'refunded' %}selected{% endif %}>Refunded</option>                            <th>Order ID</th>                <option value="payment_confirmed">Payment Confirmed</option>

                                </select>

                            </td>                            <th>Customer</th>                <option value="preparing">Preparing</option>

                            <td>

                                <select class="form-select form-select-sm order-status-select"                             <th>Items</th>                <option value="almost_ready">Almost Ready</option>

                                        onchange="updateOrderStatus({{ order['id'] }}, this.value)">

                                    <option value="pending_payment" {% if order['status'] == 'pending_payment' %}selected{% endif %}>Pending Payment</option>                            <th>Total</th>                <option value="ready_for_pickup">Ready for Pickup</option>

                                    <option value="payment_confirmed" {% if order['status'] == 'payment_confirmed' %}selected{% endif %}>Payment Confirmed</option>

                                    <option value="preparing" {% if order['status'] == 'preparing' %}selected{% endif %}>Preparing</option>                            <th>Payment Status</th>                <option value="delivered">Delivered</option>

                                    <option value="almost_ready" {% if order['status'] == 'almost_ready' %}selected{% endif %}>Almost Ready</option>

                                    <option value="ready_for_pickup" {% if order['status'] == 'ready_for_pickup' %}selected{% endif %}>Ready for Pickup</option>                            <th>Order Status</th>                <option value="completed">Completed</option>

                                    <option value="delivered" {% if order['status'] == 'delivered' %}selected{% endif %}>Delivered</option>

                                    <option value="completed" {% if order['status'] == 'completed' %}selected{% endif %}>Completed</option>                            <th>Order Time</th>                <option value="cancelled">Cancelled</option>

                                    <option value="cancelled" {% if order['status'] == 'cancelled' %}selected{% endif %}>Cancelled</option>

                                </select>                            <th>Actions</th>            </select>

                            </td>

                            <td><small>{{ order['created_at'] }}</small></td>                        </tr>        </div>

                            <td>

                                <button class="btn btn-sm btn-info" onclick="viewOrderDetails({{ order['id'] }})" title="View Details">                    </thead>        <div class="col-md-3">

                                    <i class="fas fa-eye"></i>

                                </button>                    <tbody>            <input type="date" class="form-control" id="dateFilter" placeholder="Filter by date">

                            </td>

                        </tr>                        {% for order in orders %}        </div>

                        {% endfor %}

                    </tbody>                        <tr id="order-{{ order['id'] }}" class="order-row-{{ order['status'] }}">        <div class="col-md-3">

                </table>

            </div>                            <td><strong>#{{ order['id'] }}</strong></td>            <input type="text" class="form-control" id="customerFilter" placeholder="Search customer...">

        </div>

    </div>                            <td>{{ order['customer'] }}</td>        </div>

</div>

                            <td><small class="text-muted">{{ order['items'] }}</small></td>        <div class="col-md-3">

<!-- Order Details Modal -->

<div class="modal fade" id="orderDetailsModal" tabindex="-1">                            <td><strong>₦{{ "%.2f"|format(order['total']) }}</strong></td>            <button class="btn btn-primary" onclick="applyFilters()">

    <div class="modal-dialog modal-lg">

        <div class="modal-content">                            <td>                <i class="fas fa-filter"></i> Apply Filters

            <div class="modal-header">

                <h5 class="modal-title">Order Details</h5>                                <select class="form-select form-select-sm payment-status-select"             </button>

                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>

            </div>                                        onchange="updatePaymentStatus({{ order['id'] }}, this.value)">        </div>

            <div class="modal-body" id="orderDetailsContent">

                <!-- Dynamic content will be inserted here -->                                    <option value="pending" {% if order['payment_status'] == 'pending' %}selected{% endif %}>Pending</option>    </div>

            </div>

            <div class="modal-footer">                                    <option value="paid" {% if order['payment_status'] == 'paid' %}selected{% endif %}>Paid</option></div>

                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

                <button type="button" class="btn btn-primary" onclick="printOrder()">                                    <option value="failed" {% if order['payment_status'] == 'failed' %}selected{% endif %}>Failed</option>

                    <i class="fas fa-print"></i> Print Order

                </button>                                    <option value="refunded" {% if order['payment_status'] == 'refunded' %}selected{% endif %}>Refunded</option><!-- Orders Table -->

            </div>

        </div>                                </select><div class="stat-card">

    </div>

</div>                            </td>    <div class="table-responsive">

{% endblock %}

                            <td>        <table class="table table-hover" id="ordersTable">

{% block scripts %}

<script>                                <select class="form-select form-select-sm order-status-select"             <thead class="table-light">

// WebSocket connection for real-time updates

var ws = null;                                        onchange="updateOrderStatus({{ order['id'] }}, this.value)">                <tr>



function connectWebSocket() {                                    <option value="pending_payment" {% if order['status'] == 'pending_payment' %}selected{% endif %}>Pending Payment</option>                    <th>Order ID</th>

    var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

    var wsUrl = protocol + '//' + window.location.host + '/ws/admin';                                    <option value="payment_confirmed" {% if order['status'] == 'payment_confirmed' %}selected{% endif %}>Payment Confirmed</option>                    <th>Customer</th>



    ws = new WebSocket(wsUrl);                                    <option value="preparing" {% if order['status'] == 'preparing' %}selected{% endif %}>Preparing</option>                    <th>Items</th>



    ws.onopen = function() {                                    <option value="almost_ready" {% if order['status'] == 'almost_ready' %}selected{% endif %}>Almost Ready</option>                    <th>Total</th>

        console.log('WebSocket connected');

    };                                    <option value="ready_for_pickup" {% if order['status'] == 'ready_for_pickup' %}selected{% endif %}>Ready for Pickup</option>                    <th>Status</th>



    ws.onmessage = function(event) {                                    <option value="delivered" {% if order['status'] == 'delivered' %}selected{% endif %}>Delivered</option>                    <th>Payment</th>

        var data = JSON.parse(event.data);

        if (data.type === 'new_order' || data.type === 'order_update') {                                    <option value="completed" {% if order['status'] == 'completed' %}selected{% endif %}>Completed</option>                    <th>Created</th>

            refreshOrders();

        }                                    <option value="cancelled" {% if order['status'] == 'cancelled' %}selected{% endif %}>Cancelled</option>                    <th>Actions</th>

    };

                                    </select>                </tr>

    ws.onclose = function() {

        console.log('WebSocket disconnected. Reconnecting in 5s...');                            </td>            </thead>

        setTimeout(connectWebSocket, 5000);

    };                            <td><small>{{ order['created_at'] }}</small></td>            <tbody>



    ws.onerror = function(error) {                            <td>                {% for order in orders %}

        console.error('WebSocket error:', error);

    };                                <button class="btn btn-sm btn-info" onclick="viewOrderDetails({{ order['id'] }})" title="View Details">                <tr id="order-{{ order['id'] }}">

}

                                    <i class="fas fa-eye"></i>                    <td>

// Initialize WebSocket on page load

document.addEventListener('DOMContentLoaded', function() {                                </button>                        <strong>#{{ order['id'] }}</strong>

    connectWebSocket();

    applyInitialRowStyling();                            </td>                    </td>

});

                        </tr>                    <td>

// Show alert message

function showAlert(message, type) {                        {% endfor %}                        <div>

    var alertContainer = document.getElementById('alertContainer');

    var alertDiv = document.createElement('div');                    </tbody>                            <strong>{{ order['customer'] }}</strong>

    alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';

    alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';                </table>                        </div>

    alertContainer.appendChild(alertDiv);

                </div>                    </td>

    // Auto-dismiss after 5 seconds

    setTimeout(function() {        </div>                    <td>

        alertDiv.remove();

    }, 5000);    </div>                        <small class="text-muted">{{ order['items'] }}</small>

}

</div>                    </td>

// Update order status

function updateOrderStatus(orderId, newStatus) {                    <td>

    var select = document.querySelector('#order-' + orderId + ' .order-status-select');

    var originalValue = select.value;<!-- Order Details Modal -->                        <strong>₦{{ "%.2f"|format(order['total']) }}</strong>



    fetch('/admin/api/orders/' + orderId + '/update-status', {<div class="modal fade" id="orderDetailsModal" tabindex="-1">                    </td>

        method: 'POST',

        headers: {    <div class="modal-dialog modal-lg">                    <td>

            'Content-Type': 'application/json',

        },        <div class="modal-content">                        <select class="form-select form-select-sm status-select"

        body: JSON.stringify({ status: newStatus })

    })            <div class="modal-header">                                data-order-id="{{ order['id'] }}"

    .then(function(response) {

        if (!response.ok) {                <h5 class="modal-title">Order Details</h5>                                onchange="updateOrderStatus({{ order['id'] }}, this.value)">

            throw new Error('Failed to update order status');

        }                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>                            <option value="pending_payment" {% if order['status'] == 'pending_payment' %}selected{% endif %}>Pending Payment</option>

        return response.json();

    })            </div>                            <option value="payment_confirmed" {% if order['status'] == 'payment_confirmed' %}selected{% endif %}>Payment Confirmed</option>

    .then(function(data) {

        if (data.success) {            <div class="modal-body" id="orderDetailsContent">                            <option value="preparing" {% if order['status'] == 'preparing' %}selected{% endif %}>Preparing</option>

            showAlert('Order #' + orderId + ' status updated to ' + newStatus.replace(/_/g, ' '), 'success');

            updateRowStyling(orderId, newStatus);                <!-- Dynamic content will be inserted here -->                            <option value="almost_ready" {% if order['status'] == 'almost_ready' %}selected{% endif %}>Almost Ready</option>

        } else {

            throw new Error(data.message || 'Failed to update status');            </div>                            <option value="ready_for_pickup" {% if order['status'] == 'ready_for_pickup' %}selected{% endif %}>Ready for Pickup</option>

        }

    })            <div class="modal-footer">                            <option value="delivered" {% if order['status'] == 'delivered' %}selected{% endif %}>Delivered</option>

    .catch(function(error) {

        showAlert('Error: ' + error.message, 'danger');                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>                            <option value="completed" {% if order['status'] == 'completed' %}selected{% endif %}>Completed</option>

        select.value = originalValue;

    });                <button type="button" class="btn btn-primary" onclick="printOrder()">                            <option value="cancelled" {% if order['status'] == 'cancelled' %}selected{% endif %}>Cancelled</option>

}

                    <i class="fas fa-print"></i> Print Order                        </select>

// Update payment status

function updatePaymentStatus(orderId, newStatus) {                </button>                    </td>

    var select = document.querySelector('#order-' + orderId + ' .payment-status-select');

    var originalValue = select.value;            </div>                    <td>



    fetch('/admin/api/orders/' + orderId + '/update-payment-status', {        </div>                        <select class="form-select form-select-sm payment-select"

        method: 'POST',

        headers: {    </div>                                data-order-id="{{ order['id'] }}"

            'Content-Type': 'application/json',

        },</div>                                onchange="updatePaymentStatus({{ order['id'] }}, this.value)">

        body: JSON.stringify({ payment_status: newStatus })

    }){% endblock %}                            <option value="pending" {% if order['payment_status'] == 'pending' %}selected{% endif %}>Pending</option>

    .then(function(response) {

        if (!response.ok) {                            <option value="completed" {% if order['payment_status'] == 'completed' %}selected{% endif %}>Completed</option>

            throw new Error('Failed to update payment status');

        }{% block scripts %}                            <option value="failed" {% if order['payment_status'] == 'failed' %}selected{% endif %}>Failed</option>

        return response.json();

    })<script>                            <option value="refunded" {% if order['payment_status'] == 'refunded' %}selected{% endif %}>Refunded</option>

    .then(function(data) {

        if (data.success) {// WebSocket connection for real-time updates                        </select>

            showAlert('Order #' + orderId + ' payment status updated to ' + newStatus, 'success');

        } else {let ws = null;                        {% if order['payment_method'] == 'bank_transfer' %}

            throw new Error(data.message || 'Failed to update payment status');

        }                            <button class="btn btn-sm btn-info mt-1" onclick="viewPaymentProof({{ order['id'] }})">

    })

    .catch(function(error) {function connectWebSocket() {                                View Proof

        showAlert('Error: ' + error.message, 'danger');

        select.value = originalValue;    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';                            </button>

    });

}    const wsUrl = protocol + '//' + window.location.host + '/ws/admin';                        {% endif %}



// Update row styling based on status                        </td>

function updateRowStyling(orderId, status) {

    var row = document.getElementById('order-' + orderId);    ws = new WebSocket(wsUrl);                    <td>

    if (!row) return;

                                <small>{{ order['created_at'] }}</small>

    // Remove all status classes

    row.className = row.className.replace(/order-row-\w+/g, '');    ws.onopen = function() {                    </td>



    // Add new status class        console.log('WebSocket connected');                    <td>

    row.classList.add('order-row-' + status);

        };                        <div class="btn-group btn-group-sm" role="group">

    // Apply color coding

    row.classList.remove('table-success', 'table-warning', 'table-danger', 'table-info', 'table-secondary');                                <button class="btn btn-outline-primary" onclick="viewOrderDetails({{ order['id'] }})">



    if (status === 'completed' || status === 'delivered') {    ws.onmessage = function(event) {                                <i class="fas fa-eye"></i>

        row.classList.add('table-success');

    } else if (status === 'pending_payment') {        const data = JSON.parse(event.data);                            </button>

        row.classList.add('table-warning');

    } else if (status === 'cancelled') {        if (data.type === 'new_order' || data.type === 'order_update') {                            <button class="btn btn-outline-success" onclick="printOrder({{ order['id'] }})">

        row.classList.add('table-danger');

    } else if (status === 'preparing' || status === 'almost_ready') {            refreshOrders();                                <i class="fas fa-print"></i>

        row.classList.add('table-info');

    } else if (status === 'payment_confirmed' || status === 'ready_for_pickup') {        }                            </button>

        row.classList.add('table-success');

        row.style.opacity = '0.7';    };                        </div>

    }

}                        </td>



// View order details    ws.onclose = function() {                </tr>

function viewOrderDetails(orderId) {

    fetch('/admin/api/orders/' + orderId)        console.log('WebSocket disconnected. Reconnecting in 5s...');                {% endfor %}

        .then(function(response) {

            if (!response.ok) {        setTimeout(connectWebSocket, 5000);            </tbody>

                throw new Error('Failed to load order details');

            }    };        </table>

            return response.json();

        })        </div>

        .then(function(order) {

            displayOrderDetails(order);    ws.onerror = function(error) {</div>

        })

        .catch(function(error) {        console.error('WebSocket error:', error);

            showAlert('Error: ' + error.message, 'danger');

        });    };<!-- Order Details Modal -->

}

}<div class="modal fade" id="orderDetailsModal" tabindex="-1">

// Display order details in modal

function displayOrderDetails(order) {    <div class="modal-dialog modal-lg">

    var itemsHtml = '';

    if (order.items && order.items.length > 0) {// Initialize WebSocket on page load        <div class="modal-content">

        order.items.forEach(function(item) {

            var specialInstructions = item.special_instructions ? '<br><small class="text-muted"><i class="fas fa-comment-dots"></i> ' + item.special_instructions + '</small>' : '';document.addEventListener('DOMContentLoaded', function() {            <div class="modal-header">

            itemsHtml += '<li class="list-group-item">' +

                '<div class="d-flex justify-content-between align-items-start">' +    connectWebSocket();                <h5 class="modal-title">Order Details</h5>

                '<div class="flex-grow-1">' +

                '<strong>' + item.quantity + 'x ' + item.name + '</strong>' +});                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>

                specialInstructions +

                '</div>' +            </div>

                '<span class="badge bg-primary rounded-pill">₦' + parseFloat(item.unit_price).toFixed(2) + '</span>' +

                '</div>' +// Show alert message            <div class="modal-body" id="orderDetailsContent">

                '</li>';

        });function showAlert(message, type) {                <!-- Order details will be loaded here -->

    } else {

        itemsHtml = '<li class="list-group-item">No items</li>';    const alertContainer = document.getElementById('alertContainer');            </div>

    }

        const alertDiv = document.createElement('div');            <div class="modal-footer">

    var taxHtml = '';

    if (order.tax && order.tax > 0) {    alertDiv.className = 'alert alert-' + type + ' alert-dismissible fade show';                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>

        taxHtml = '<div class="d-flex justify-content-between mb-2">' +

            '<span>Tax:</span>' +    alertDiv.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';                <button type="button" class="btn btn-primary" onclick="printOrder()">Print Order</button>

            '<strong>₦' + parseFloat(order.tax).toFixed(2) + '</strong>' +

            '</div>';    alertContainer.appendChild(alertDiv);            </div>

    }

                </div>

    var deliveryHtml = '';

    if (order.delivery_fee && order.delivery_fee > 0) {    // Auto-dismiss after 5 seconds    </div>

        deliveryHtml = '<div class="d-flex justify-content-between mb-2">' +

            '<span>Delivery Fee:</span>' +    setTimeout(function() {</div>

            '<strong>₦' + parseFloat(order.delivery_fee).toFixed(2) + '</strong>' +

            '</div>';        alertDiv.remove();{% endblock %}

    }

        }, 5000);

    var receiptHtml = '';

    if (order.bank_transfer_receipt) {}{% block scripts %}

        receiptHtml = '<div class="mt-3 p-3 bg-light rounded">' +

            '<h6><i class="fas fa-receipt me-2"></i>Payment Receipt</h6>' +<script>

            '<a href="' + order.bank_transfer_receipt + '" target="_blank" class="btn btn-sm btn-primary mb-2">' +

            '<i class="fas fa-external-link-alt"></i> View Full Size' +// Update order status// Escape special characters in user input to prevent breaking template literals

            '</a>' +

            '<div class="mt-2">' +function updateOrderStatus(orderId, newStatus) {function escapeTemplateString(str) {

            '<img src="' + order.bank_transfer_receipt + '" alt="Payment Receipt" ' +

            'class="img-fluid rounded border" ' +    const select = document.querySelector('#order-' + orderId + ' .order-status-select');    if (!str) return '';

            'style="max-width: 100%; max-height: 300px; object-fit: contain;">' +

            '</div>' +    const originalValue = select.value;    return str.replace(/`/g, '\\`').replace(/\$/g, '\\$').replace(/\\/g, '\\\\');

            '</div>';

    }    }



    var paymentRefHtml = '';    fetch('/admin/api/orders/' + orderId + '/update-status', {

    if (order.payment_reference) {

        paymentRefHtml = '<p><strong>Payment Reference:</strong> ' + order.payment_reference + '</p>';        method: 'POST',function updateOrderStatus(orderId, newStatus) {

    }

            headers: {    fetch(`/admin/api/orders/${orderId}/update-status`, {

    var specialInstrHtml = '';

    if (order.special_instructions) {            'Content-Type': 'application/json',        method: 'POST',

        specialInstrHtml = '<p><strong>Special Instructions:</strong><br><span class="text-muted">' + order.special_instructions + '</span></p>';

    }        },        headers: {



    var content = '<div class="row">' +        body: JSON.stringify({ status: newStatus })            'Content-Type': 'application/json',

        '<div class="col-md-6">' +

        '<h6 class="border-bottom pb-2 mb-3"><i class="fas fa-info-circle me-2"></i>Order Information</h6>' +    })        },

        '<p><strong>Order Number:</strong> ' + (order.order_number || 'N/A') + '</p>' +

        '<p><strong>Customer Name:</strong> ' + (order.customer_name || 'N/A') + '</p>' +    .then(function(response) {        body: JSON.stringify({status: newStatus})

        '<p><strong>Email:</strong> ' + (order.customer_email || 'N/A') + '</p>' +

        '<p><strong>Phone:</strong> ' + (order.customer_phone || 'N/A') + '</p>' +        if (!response.ok) {    })

        '<p><strong>Order Status:</strong> <span class="badge bg-info">' + (order.status ? order.status.replace(/_/g, ' ').toUpperCase() : 'N/A') + '</span></p>' +

        '<p><strong>Payment Status:</strong> <span class="badge bg-success">' + (order.payment_status ? order.payment_status.toUpperCase() : 'N/A') + '</span></p>' +            throw new Error('Failed to update order status');    .then(response => {

        '<p><strong>Payment Method:</strong> ' + (order.payment_method || 'N/A') + '</p>' +

        paymentRefHtml +        }        if (!response.ok) {

        '<p><strong>Order Time:</strong> ' + (order.created_at || 'N/A') + '</p>' +

        specialInstrHtml +        return response.json();            return response.json().then(err => Promise.reject(err));

        receiptHtml +

        '</div>' +    })        }

        '<div class="col-md-6">' +

        '<h6 class="border-bottom pb-2 mb-3"><i class="fas fa-utensils me-2"></i>Order Items</h6>' +    .then(function(data) {        return response.json();

        '<ul class="list-group mb-3">' +

        itemsHtml +        if (data.success) {    })

        '</ul>' +

        '<div class="card bg-light">' +            showAlert('Order #' + orderId + ' status updated to ' + newStatus.replace('_', ' '), 'success');    .then(data => {

        '<div class="card-body">' +

        '<div class="d-flex justify-content-between mb-2">' +            updateRowStyling(orderId, newStatus);        if (data.success) {

        '<span>Subtotal:</span>' +

        '<strong>₦' + (order.subtotal ? parseFloat(order.subtotal).toFixed(2) : '0.00') + '</strong>' +        } else {            // Update the row styling based on status

        '</div>' +

        taxHtml +            throw new Error(data.message || 'Failed to update status');            const row = document.getElementById(`order-${orderId}`);

        deliveryHtml +

        '<hr>' +        }            if (row) {

        '<div class="d-flex justify-content-between">' +

        '<h5>Total:</h5>' +    })                row.classList.remove('table-success', 'table-warning', 'table-info');

        '<h5 class="text-primary">₦' + (order.total ? parseFloat(order.total).toFixed(2) : '0.00') + '</h5>' +

        '</div>' +    .catch(function(error) {

        '</div>' +

        '</div>' +        showAlert('Error: ' + error.message, 'danger');                if (newStatus === 'completed') {

        '</div>' +

        '</div>';        select.value = originalValue; // Revert dropdown                    row.classList.add('table-success');



    document.getElementById('orderDetailsContent').innerHTML = content;    });                } else if (newStatus === 'delivered') {

    new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();

}}                    row.classList.add('table-success');



// Print order                } else if (newStatus === 'preparing') {

function printOrder() {

    window.print();// Update payment status                    row.classList.add('table-warning');

}

function updatePaymentStatus(orderId, newStatus) {                } else if (newStatus === 'ready_for_pickup') {

// Refresh orders

function refreshOrders() {    const select = document.querySelector('#order-' + orderId + ' .payment-status-select');                    row.classList.add('table-info');

    location.reload();

}    const originalValue = select.value;                }



// Apply initial row styling on page load                }

function applyInitialRowStyling() {

    var rows = document.querySelectorAll('[id^="order-"]');    fetch('/admin/api/orders/' + orderId + '/update-payment-status', {

    rows.forEach(function(row) {

        var statusSelect = row.querySelector('.order-status-select');        method: 'POST',            // Show success message

        if (statusSelect) {

            updateRowStyling(row.id.replace('order-', ''), statusSelect.value);        headers: {            showAlert('Order status updated successfully!', 'success');

        }

    });            'Content-Type': 'application/json',        } else {

}

</script>        },            showAlert(data.message || 'Failed to update order status', 'danger');



<style>        body: JSON.stringify({ payment_status: newStatus })        }

/* Status-based row colors */

.order-row-completed,    })    })

.order-row-delivered {

    background-color: #d4edda !important;    .then(function(response) {    .catch(error => {

}

        if (!response.ok) {        console.error('Error updating order status:', error);

.order-row-pending_payment {

    background-color: #fff3cd !important;            throw new Error('Failed to update payment status');        const errorMsg = error.detail || error.message || 'Error updating order status';

}

        }        showAlert(errorMsg, 'danger');

.order-row-cancelled {

    background-color: #f8d7da !important;        return response.json();    });

}

    })}

.order-row-preparing,

.order-row-almost_ready {    .then(function(data) {

    background-color: #d1ecf1 !important;

}        if (data.success) {function updatePaymentStatus(orderId, newPaymentStatus) {



.order-row-payment_confirmed,            showAlert('Order #' + orderId + ' payment status updated to ' + newStatus, 'success');    fetch(`/admin/api/orders/${orderId}/update-payment-status`, {

.order-row-ready_for_pickup {

    background-color: #d4edda !important;        } else {        method: 'POST',

    opacity: 0.8;

}            throw new Error(data.message || 'Failed to update payment status');        headers: {



/* Responsive adjustments */        }            'Content-Type': 'application/json',

@media (max-width: 768px) {

    .table-responsive {    })        },

        font-size: 0.9rem;

    }    .catch(function(error) {        body: JSON.stringify({payment_status: newPaymentStatus})



    .btn-sm {        showAlert('Error: ' + error.message, 'danger');    })

        padding: 0.25rem 0.5rem;

        font-size: 0.75rem;        select.value = originalValue; // Revert dropdown    .then(response => response.json())

    }

        });    .then(data => {

    .form-select-sm {

        font-size: 0.8rem;}        if (data.success) {

    }

}            showAlert('Payment status updated successfully!', 'success');



/* Print styles */// Update row styling based on status        }

@media print {

    .btn, .modal-header, .modal-footer {function updateRowStyling(orderId, status) {    })

        display: none !important;

    }    const row = document.getElementById('order-' + orderId);    .catch(error => {



    .modal-body {    if (!row) return;        console.error('Error:', error);

        padding: 0;

    }            showAlert('Error updating payment status', 'danger');

}

</style>    // Remove all status classes    });

{% endblock %}

    row.className = row.className.replace(/order-row-\w+/g, '');}



    // Add new status classfunction viewPaymentProof(orderId) {

    row.classList.add('order-row-' + status);    fetch(`/admin/api/orders/${orderId}/payment-proof`)

        .then(response => response.json())

    // Apply color coding    .then(data => {

    row.classList.remove('table-success', 'table-warning', 'table-danger', 'table-info', 'table-secondary');        if (data.success) {

                const proof = data.data;

    if (status === 'completed' || status === 'delivered') {            const proofHtml = `

        row.classList.add('table-success');                <div class="row">

    } else if (status === 'pending_payment') {                    <div class="col-md-6">

        row.classList.add('table-warning');                        <h6>Payment Information</h6>

    } else if (status === 'cancelled') {                        <p><strong>Reference Number:</strong> ${proof.reference_number}</p>

        row.classList.add('table-danger');                        <p><strong>Amount:</strong> $${proof.amount.toFixed(2)}</p>

    } else if (status === 'preparing' || status === 'almost_ready') {                        <p><strong>Sender Name:</strong> ${proof.sender_name}</p>

        row.classList.add('table-info');                        <p><strong>Sender Account:</strong> ${proof.sender_account}</p>

    } else if (status === 'payment_confirmed' || status === 'ready_for_pickup') {                        <p><strong>Verification Status:</strong>

        row.classList.add('table-success');                            <span class="badge bg-${proof.verification_status === 'verified' ? 'success' : 'warning'}">

        row.style.opacity = '0.7';                                ${proof.verification_status}

    }                            </span>

}                        </p>

                        ${proof.notes ? `<p><strong>Notes:</strong> ${proof.notes}</p>` : ''}

// View order details                    </div>

function viewOrderDetails(orderId) {                    <div class="col-md-6">

    fetch('/admin/api/orders/' + orderId)                        <h6>Payment Receipt</h6>

        .then(function(response) {                        ${proof.receipt_image_url ?

            if (!response.ok) {                            `<img src="/uploads/${proof.receipt_image_url}" class="img-fluid" alt="Payment Receipt" />` :

                throw new Error('Failed to load order details');                            '<p class="text-muted">No receipt image uploaded</p>'

            }                        }

            return response.json();                    </div>

        })                </div>

        .then(function(order) {            `;

            displayOrderDetails(order);            document.getElementById('orderDetailsContent').innerHTML = proofHtml;

        })            new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();

        .catch(function(error) {        } else {

            showAlert('Error: ' + error.message, 'danger');            showAlert('No payment proof found for this order', 'warning');

        });        }

}    })

    .catch(error => {

// Display order details in modal        console.error('Error:', error);

function displayOrderDetails(order) {        showAlert('Error loading payment proof', 'danger');

    var itemsHtml = '';    });

    if (order.items && order.items.length > 0) {}

        order.items.forEach(function(item) {

            var specialInstructions = item.special_instructions ? '<br><small class="text-muted"><i class="fas fa-comment-dots"></i> ' + item.special_instructions + '</small>' : '';function viewOrderDetails(orderId) {

            itemsHtml += '<li class="list-group-item">' +    // Fetch real order details

                '<div class="d-flex justify-content-between align-items-start">' +    fetch(`/admin/api/orders/${orderId}`)

                '<div class="flex-grow-1">' +        .then(response => {

                '<strong>' + item.quantity + 'x ' + item.name + '</strong>' +            if (!response.ok) {

                specialInstructions +                return response.json().then(err => Promise.reject(err));

                '</div>' +            }

                '<span class="badge bg-primary rounded-pill">₦' + parseFloat(item.unit_price).toFixed(2) + '</span>' +            return response.json();

                '</div>' +        })

                '</li>';        .then(order => {

        });            const statusBadge = getStatusBadge(order.status);

    } else {            const paymentBadge = getPaymentBadge(order.payment_status);

        itemsHtml = '<li class="list-group-item">No items</li>';

    }            const orderDetails = `

                    <div class="row">

    var taxHtml = '';                    <div class="col-md-6">

    if (order.tax && order.tax > 0) {                        <h6>Order Information</h6>

        taxHtml = '<div class="d-flex justify-content-between mb-2">' +                        <p><strong>Order Number:</strong> ${order.order_number}</p>

            '<span>Tax:</span>' +                        <p><strong>Customer:</strong> ${order.customer_name}</p>

            '<strong>₦' + parseFloat(order.tax).toFixed(2) + '</strong>' +                        <p><strong>Email:</strong> ${order.customer_email}</p>

            '</div>';                        <p><strong>Phone:</strong> ${order.customer_phone || 'N/A'}</p>

    }                        <p><strong>Status:</strong> ${statusBadge}</p>

                            <p><strong>Payment:</strong> ${paymentBadge}</p>

    var deliveryHtml = '';                        <p><strong>Payment Method:</strong> ${order.payment_method || 'N/A'}</p>

    if (order.delivery_fee && order.delivery_fee > 0) {                        ${order.payment_reference ? `<p><strong>Payment Reference:</strong> ${escapeTemplateString(order.payment_reference)}</p>` : ''}

        deliveryHtml = '<div class="d-flex justify-content-between mb-2">' +                        <p><strong>Order Time:</strong> ${order.created_at}</p>

            '<span>Delivery Fee:</span>' +                        ${order.special_instructions ? `<p><strong>Special Instructions:</strong><br>${escapeTemplateString(order.special_instructions)}</p>` : ''}

            '<strong>₦' + parseFloat(order.delivery_fee).toFixed(2) + '</strong>' +                        ${order.bank_transfer_receipt ? `

            '</div>';                            <div class="mt-3">

    }                                <h6>Payment Receipt</h6>

                                    <a href="${order.bank_transfer_receipt}" target="_blank" class="btn btn-sm btn-primary">

    var receiptHtml = '';                                    <i class="fas fa-receipt"></i> View Receipt

    if (order.bank_transfer_receipt) {                                </a>

        receiptHtml = '<div class="mt-3 p-3 bg-light rounded">' +                                <div class="mt-2">

            '<h6><i class="fas fa-receipt me-2"></i>Payment Receipt</h6>' +                                    <img src="${order.bank_transfer_receipt}" alt="Payment Receipt" class="img-fluid" style="max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 4px;">

            '<a href="' + order.bank_transfer_receipt + '" target="_blank" class="btn btn-sm btn-primary mb-2">' +                                </div>

            '<i class="fas fa-external-link-alt"></i> View Full Size' +                            </div>

            '</a>' +                        ` : ''}

            '<div class="mt-2">' +                    </div>

            '<img src="' + order.bank_transfer_receipt + '" alt="Payment Receipt" ' +                    <div class="col-md-6">

            'class="img-fluid rounded border" ' +                        <h6>Order Items</h6>

            'style="max-width: 100%; max-height: 300px; object-fit: contain;">' +                        <ul class="list-unstyled">

            '</div>' +                            ${order.items.map(item => `

            '</div>';                                <li class="mb-2">

    }                                    ${item.quantity}x ${escapeTemplateString(item.name)} - ₦${item.unit_price.toFixed(2)}

                                        ${item.special_instructions ? `<br><small class="text-muted">Note: ${escapeTemplateString(item.special_instructions)}</small>` : ''}

    var paymentRefHtml = '';                                </li>

    if (order.payment_reference) {                            `).join('')}

        paymentRefHtml = '<p><strong>Payment Reference:</strong> ' + order.payment_reference + '</p>';                        </ul>

    }                        <hr>

                            <p><strong>Subtotal:</strong> ₦${order.subtotal.toFixed(2)}</p>

    var specialInstrHtml = '';                        ${order.tax > 0 ? `<p><strong>Tax:</strong> ₦${order.tax.toFixed(2)}</p>` : ''}

    if (order.special_instructions) {                        ${order.delivery_fee > 0 ? `<p><strong>Delivery Fee:</strong> ₦${order.delivery_fee.toFixed(2)}</p>` : ''}

        specialInstrHtml = '<p><strong>Special Instructions:</strong><br><span class="text-muted">' + order.special_instructions + '</span></p>';                        <h5><strong>Total: ₦${order.total.toFixed(2)}</strong></h5>

    }                    </div>

                    </div>

    var content = '<div class="row">' +            `;

        '<div class="col-md-6">' +

        '<h6 class="border-bottom pb-2 mb-3"><i class="fas fa-info-circle me-2"></i>Order Information</h6>' +            const modalContent = document.getElementById('orderDetailsContent');

        '<p><strong>Order Number:</strong> ' + (order.order_number || 'N/A') + '</p>' +            if (modalContent) {

        '<p><strong>Customer Name:</strong> ' + (order.customer_name || 'N/A') + '</p>' +                modalContent.innerHTML = orderDetails;

        '<p><strong>Email:</strong> ' + (order.customer_email || 'N/A') + '</p>' +                const modalEl = document.getElementById('orderDetailsModal');

        '<p><strong>Phone:</strong> ' + (order.customer_phone || 'N/A') + '</p>' +                if (modalEl) {

        '<p><strong>Order Status:</strong> <span class="badge bg-info">' + (order.status ? order.status.replace('_', ' ').toUpperCase() : 'N/A') + '</span></p>' +                    new bootstrap.Modal(modalEl).show();

        '<p><strong>Payment Status:</strong> <span class="badge bg-success">' + (order.payment_status ? order.payment_status.toUpperCase() : 'N/A') + '</span></p>' +                } else {

        '<p><strong>Payment Method:</strong> ' + (order.payment_method || 'N/A') + '</p>' +                    showAlert('Modal element not found', 'danger');

        paymentRefHtml +                }

        '<p><strong>Order Time:</strong> ' + (order.created_at || 'N/A') + '</p>' +            } else {

        specialInstrHtml +                showAlert('Modal content element not found', 'danger');

        receiptHtml +            }

        '</div>' +        })

        '<div class="col-md-6">' +        .catch(error => {

        '<h6 class="border-bottom pb-2 mb-3"><i class="fas fa-utensils me-2"></i>Order Items</h6>' +            console.error('Error loading order details:', error);

        '<ul class="list-group mb-3">' +            const errorMsg = error.detail || error.message || 'Error loading order details';

        itemsHtml +            showAlert(errorMsg, 'danger');

        '</ul>' +        });

        '<div class="card bg-light">' +}

        '<div class="card-body">' +

        '<div class="d-flex justify-content-between mb-2">' +function getStatusBadge(status) {

        '<span>Subtotal:</span>' +    const badges = {

        '<strong>₦' + (order.subtotal ? parseFloat(order.subtotal).toFixed(2) : '0.00') + '</strong>' +        'pending_payment': '<span class="badge bg-warning">Pending Payment</span>',

        '</div>' +        'payment_confirmed': '<span class="badge bg-info">Payment Confirmed</span>',

        taxHtml +        'preparing': '<span class="badge bg-primary">Preparing</span>',

        deliveryHtml +        'almost_ready': '<span class="badge bg-info">Almost Ready</span>',

        '<hr>' +        'ready_for_pickup': '<span class="badge bg-success">Ready for Pickup</span>',

        '<div class="d-flex justify-content-between">' +        'delivered': '<span class="badge bg-success">Delivered</span>',

        '<h5>Total:</h5>' +        'completed': '<span class="badge bg-success">Completed</span>',

        '<h5 class="text-primary">₦' + (order.total ? parseFloat(order.total).toFixed(2) : '0.00') + '</h5>' +        'cancelled': '<span class="badge bg-danger">Cancelled</span>'

        '</div>' +    };

        '</div>' +    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;

        '</div>' +}

        '</div>' +

        '</div>';function getPaymentBadge(status) {

        const badges = {

    document.getElementById('orderDetailsContent').innerHTML = content;        'pending': '<span class="badge bg-warning">Pending</span>',

    new bootstrap.Modal(document.getElementById('orderDetailsModal')).show();        'completed': '<span class="badge bg-success">Completed</span>',

}        'failed': '<span class="badge bg-danger">Failed</span>',

        'refunded': '<span class="badge bg-info">Refunded</span>'

// Print order    };

function printOrder() {    return badges[status] || `<span class="badge bg-secondary">${status}</span>`;

    window.print();}

}

function printOrder(orderId) {

// Refresh orders    // Fetch order details and generate print receipt

function refreshOrders() {    fetch(`/admin/api/orders/${orderId}`)

    location.reload();        .then(response => response.json())

}        .then(order => {

            const printWindow = window.open('', '_blank');

// Apply initial row styling on page load            const receipt = `

document.addEventListener('DOMContentLoaded', function() {                <!DOCTYPE html>

    const rows = document.querySelectorAll('[id^="order-"]');                <html>

    rows.forEach(function(row) {                <head>

        const statusSelect = row.querySelector('.order-status-select');                    <title>Order Receipt #${order.order_number}</title>

        if (statusSelect) {                    <style>

            updateRowStyling(row.id.replace('order-', ''), statusSelect.value);                        body {

        }                            font-family: Arial, sans-serif;

    });                            padding: 20px;

});                            max-width: 800px;

</script>                            margin: 0 auto;

                        }

<style>                        .header {

/* Status-based row colors */                            text-align: center;

.order-row-completed,                            border-bottom: 2px solid #333;

.order-row-delivered {                            padding-bottom: 20px;

    background-color: #d4edda !important;                            margin-bottom: 20px;

}                        }

                        .header h1 {

.order-row-pending_payment {                            margin: 0;

    background-color: #fff3cd !important;                            color: #333;

}                        }

                        .order-info {

.order-row-cancelled {                            margin-bottom: 30px;

    background-color: #f8d7da !important;                        }

}                        .order-info p {

                            margin: 5px 0;

.order-row-preparing,                            line-height: 1.6;

.order-row-almost_ready {                        }

    background-color: #d1ecf1 !important;                        .items-table {

}                            width: 100%;

                            border-collapse: collapse;

.order-row-payment_confirmed,                            margin-bottom: 20px;

.order-row-ready_for_pickup {                        }

    background-color: #d4edda !important;                        .items-table th,

    opacity: 0.8;                        .items-table td {

}                            padding: 10px;

                            text-align: left;

/* Responsive adjustments */                            border-bottom: 1px solid #ddd;

@media (max-width: 768px) {                        }

    .table-responsive {                        .items-table th {

        font-size: 0.9rem;                            background-color: #f5f5f5;

    }                            font-weight: bold;

                            }

    .btn-sm {                        .totals {

        padding: 0.25rem 0.5rem;                            text-align: right;

        font-size: 0.75rem;                            margin-top: 20px;

    }                        }

                            .totals p {

    .form-select-sm {                            margin: 5px 0;

        font-size: 0.8rem;                        }

    }                        .total-final {

}                            font-size: 1.2em;

                            font-weight: bold;

/* Print styles */                            border-top: 2px solid #333;

@media print {                            padding-top: 10px;

    .btn, .modal-header, .modal-footer {                            margin-top: 10px;

        display: none !important;                        }

    }                        .footer {

                                text-align: center;

    .modal-body {                            margin-top: 30px;

        padding: 0;                            padding-top: 20px;

    }                            border-top: 1px solid #ddd;

}                            color: #666;

</style>                        }

{% endblock %}                        @media print {

                            body {
                                padding: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Vendorr Restaurant</h1>
                        <p>Order Receipt</p>
                    </div>

                    <div class="order-info">
                        <p><strong>Order Number:</strong> ${order.order_number}</p>
                        <p><strong>Date:</strong> ${order.created_at}</p>
                        <p><strong>Customer:</strong> ${order.customer_name}</p>
                        <p><strong>Phone:</strong> ${order.customer_phone || 'N/A'}</p>
                        <p><strong>Email:</strong> ${order.customer_email}</p>
                        <p><strong>Status:</strong> ${order.status.replace(/_/g, ' ').toUpperCase()}</p>
                        <p><strong>Payment Status:</strong> ${order.payment_status.toUpperCase()}</p>
                        <p><strong>Payment Method:</strong> ${order.payment_method || 'N/A'}</p>
                        ${order.special_instructions ? `<p><strong>Special Instructions:</strong> ${order.special_instructions}</p>` : ''}
                    </div>

                    <table class="items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th style="text-align: center;">Qty</th>
                                <th style="text-align: right;">Unit Price</th>
                                <th style="text-align: right;">Subtotal</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${order.items.map(item => `
                                <tr>
                                    <td>
                                        ${item.name}
                                        ${item.special_instructions ? `<br><small style="color: #666;">Note: ${item.special_instructions}</small>` : ''}
                                    </td>
                                    <td style="text-align: center;">${item.quantity}</td>
                                    <td style="text-align: right;">₦${item.unit_price.toFixed(2)}</td>
                                    <td style="text-align: right;">₦${item.subtotal.toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>

                    <div class="totals">
                        <p><strong>Subtotal:</strong> ₦${order.subtotal.toFixed(2)}</p>
                        ${order.tax > 0 ? `<p><strong>Tax:</strong> ₦${order.tax.toFixed(2)}</p>` : ''}
                        ${order.delivery_fee > 0 ? `<p><strong>Delivery Fee:</strong> ₦${order.delivery_fee.toFixed(2)}</p>` : ''}
                        <p class="total-final"><strong>TOTAL:</strong> ₦${order.total.toFixed(2)}</p>
                    </div>

                    <div class="footer">
                        <p>Thank you for your order!</p>
                        <p>For any inquiries, please contact us.</p>
                    </div>

                    <script>
                        window.onload = function() {
                            window.print();
                            window.onafterprint = function() {
                                window.close();
                            };
                        };
                    </script>
                </body>
                </html>
            `;

            printWindow.document.write(receipt);
            printWindow.document.close();
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error loading order for printing', 'danger');
        });
}

function refreshOrders() {
    location.reload();
}

function applyFilters() {
    // In production, implement filtering logic
    showAlert('Filters applied successfully!', 'info');
}

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.top = '20px';
    alertDiv.style.right = '20px';
    alertDiv.style.zIndex = '9999';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);

    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
